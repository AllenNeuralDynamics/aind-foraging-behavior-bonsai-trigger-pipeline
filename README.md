# Foraging Behavior Pipeline for Bonsai
(Han Hou @ Aug 2023)

***This is still a temporary workaround until AIND behavior metadata schema is implemented.***

## Pipeline structure

#### 1. (On Han's PC) Upload raw behavior data to cloud ([github](https://github.com/hanhou/code_cache/blob/master/sync_bonsai/behavior_pipeline_bonsai.py))
   - From all behavior rigs (currently only Tower-5 in Rm 347), fetch raw behavior files (.json) generated by the [foraging-bonsai GUI](https://github.com/AllenNeuralDynamics/dynamic-foraging-task)
   - Turn .json files into .nwb files, which contain both data and metadata
   - Upload all .nwb files to a single S3 bucket `s3://aind-behavior-data/foraging_nwb_bonsai/`
     
#### 2. (In Code Ocean, this repo) Trigger computation ([`CO capsule: foraging_behavior_bonsai_pipeline_trigger`](https://codeocean.allenneuraldynamics.org/capsule/9148690/), [github](https://github.com/AllenNeuralDynamics/aind-foraging-behavior-bonsai-trigger-pipeline/blob/main/code/run_capsule.py))
   - Identify unprocessed .nwb files ([github](https://github.com/AllenNeuralDynamics/aind-foraging-behavior-bonsai-trigger-pipeline/blob/945ff92d98b8759668ff7c37c823af6c49273e20/code/run_capsule.py#L18-L31))
   - Send unprocessed .nwb files to [`CO pipeline: Han_pipeline_foraging_behavior_bonsai`](https://codeocean.allenneuraldynamics.org/capsule/8633725/tree).<br>
   In the CO pipeline:
     - Distribute .nwb files to parallel workers ([`CO capsule: foraging_behavior_bonsai_pipeline_assign_job`](https://codeocean.allenneuraldynamics.org/capsule/0827783/tree), [github](https://github.com/AllenNeuralDynamics/aind-foraging-behavior-bonsai-assign-job))
     - Do real analysis on each .nwb file ([`CO capsule: foraging_behavior_bonsai_nwb`](https://codeocean.allenneuraldynamics.org/capsule/5625005/tree), [github](https://github.com/AllenNeuralDynamics/aind-foraging-behavior-bonsai-basic)), where arbitrary dataframes and figures are generated.
   - Collect and combine results from the workers ([`CO capsule: foraging_behavior_bonsai_pipeline_collect_and_upload_results`](https://codeocean.allenneuraldynamics.org/capsule/0579904/tree), [github](https://github.com/AllenNeuralDynamics/aind-foraging-behavior-bonsai-collect-results))
   - Upload results to this S3 bucket `s3://aind-behavior-data/foraging_nwb_bonsai_processed/`

#### 3. (In Code Ocean) Visualization by Streamlit app ([`CO capsule: foraging-behavior-browser`](https://codeocean.allenneuraldynamics.org/capsule/3373065/), [github](https://github.com/AllenNeuralDynamics/foraging-behavior-browser))
The Streamlit app fetches data from the above S3 bucket and generates data viz. You could run the app either on [Code Ocean](https://codeocean.allenneuraldynamics.org/cw/d4dd4015-ded7-4cab-b7bb-8b1113a5dd86/proxy/8501/Bonsai) (recommended) or on [Streamlit public cloud](https://foraging-behavior-browser.streamlit.app/Bonsai)

## How to add more rigs
- On the rig PC, share the data folder on the network.
- Let me know the IP address, path to the data folder, and Windows credentials. I will create a new entry [here](https://github.com/hanhou/code_cache/blob/51485cf3609fa49902a78e404c1f1b60837467e6/sync_bonsai/behavior_pipeline_bonsai.py#L19-L21).

## How to add more analyses
The pipeline is still a prototype at this moment. As you can see in the [Streamlit app](https://foraging-behavior-browser.streamlit.app/Bonsai), so far I only implemented [two basic analyses](https://github.com/AllenNeuralDynamics/aind-foraging-behavior-bonsai-basic/blob/e740865cf7c5ed9c649147156d8b2afada714249/code/process_nwbs.py#L181-L195): 
- compute essential session-wise stats
- generate a simple plot of choice-reward history
  
To add more analyses to the pipeline, just plug in your own function [here](https://github.com/AllenNeuralDynamics/aind-foraging-behavior-bonsai-basic/blob/e740865cf7c5ed9c649147156d8b2afada714249/code/process_nwbs.py#L181-L195). Your function should take `nwb` as an input and generate plots or any other results with filename starting with `session_id`.

If you would like to access the .nwb files directly or do analysis outside Code Ocean (not recommended though), check out this bucket `s3://aind-behavior-data/foraging_nwb_bonsai/`


## What's next
We will likely be refactoring the pipeline after we figure out the AIND behavior metadata schema, but the core ideas and code developed here will remain. Stay tuned.
